<!DOCTYPE HTML>
<html lang="en" >
    <head><meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"><title>04 - All request · Pycon Workshop Bloomreach</title><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="description" content="On Pycon 2022 Bloomreach reveals their hiring assignment. On this pages are documents describing how to implement it,  and questions that will help you to understand better the assignment and things used in the implementation."><meta name="generator" content="Jekyll (using style of GitBook 3.2.3)"><meta name="author" content="Ondrej Unger"><link rel="stylesheet" href="/pycon-2022/assets/gitbook/style.css">
<link rel="stylesheet" href="/pycon-2022/assets/gitbook/gitbook-plugin-fontsettings/website.css">
<link rel="stylesheet" href="/pycon-2022/assets/gitbook/gitbook-plugin-search-pro/search.css">
<link rel="stylesheet" href="/pycon-2022/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.css">

<link rel="stylesheet" href="/pycon-2022/assets/gitbook/rouge/colorful.css">

<link rel="stylesheet" href="/pycon-2022/assets/gitbook/custom.css">

<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/pycon-2022/assets/gitbook/images/apple-touch-icon-precomposed-152.png">
<link rel="shortcut icon" href="/pycon-2022//assets/gitbook/images/favicon.png" type="image/x-icon">





<script>
    MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        svg: {
            fontCache: 'global'
        }
    };
</script>
            <link rel="prev" href="/pycon-2022/implementation/2022-09-09-03-timeout.html" />
        

        
            <link rel="next" href="/pycon-2022/implementation/2022-09-09-05-add-tests.html" />
        
    </head>
    <body>
        <div class="book"><div class="book-summary">
    <nav role="navigation">
        <div id="book-search-input" role="search">
            <input type="text" placeholder="Type to search" />
        </div>
        <div id="book-search-input-link" role="search">
            <a href="/pycon-2022/assets/search.html">Click to Search</a>
        </div>
        <ul class="summary">
            
            <li class="chapter" data-level="1.1" data-path="/pycon-2022">
            
                <a href="/pycon-2022/">
                    Pycon Workshop Bloomreach
                </a>
            </li>

            <li class="divider"></li>

            
                <!-- <p>pages</p> -->
                
                    

                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pycon-2022/pages/about/">
                        
                            <a href="/pycon-2022/pages/about/">
                                About
                            </a>
                            
                                
                            
                        </li>
                    

                    
                        <li class="divider"></li>
                    
                
            
                <!-- <p>posts</p> -->
                
                    

                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pycon-2022/assignment/2022-09-09-00-assigment.html">
                        
                            <a href="/pycon-2022/assignment/2022-09-09-00-assigment.html">
                                00 - Assignment
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pycon-2022/implementation/2022-09-09-01-start.html">
                        
                            <a href="/pycon-2022/implementation/2022-09-09-01-start.html">
                                01 - Start
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pycon-2022/implementation/2022-09-09-02-first-request.html">
                        
                            <a href="/pycon-2022/implementation/2022-09-09-02-first-request.html">
                                02 - First Request
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pycon-2022/implementation/2022-09-09-03-timeout.html">
                        
                            <a href="/pycon-2022/implementation/2022-09-09-03-timeout.html">
                                03 - Timeout
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter active" data-level="1.2" data-path="/pycon-2022/implementation/2022-09-09-04-all-request.html">
                        
                            <a href="/pycon-2022/implementation/2022-09-09-04-all-request.html">
                                04 - All request
                            </a>
                            
                                
                                    <ul><li><a href="#implementing-the-second-and-third-request">Implementing the second and third request</a></li></ul>

                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pycon-2022/implementation/2022-09-09-05-add-tests.html">
                        
                            <a href="/pycon-2022/implementation/2022-09-09-05-add-tests.html">
                                05 - Add tests
                            </a>
                            
                                
                            
                        </li>
                    

                    
                        <li class="divider"></li>
                    
                
            

            <li>
                <a href="https://github.com/UOndro/pycon-2022/fork" target="blank" class="gitbook-link">
                    Fork it Now!
                </a>
            </li>
        </ul>
    </nav>
</div>
<div class="book-body">
                <div class="book-header" role="navigation">
                    <!-- Title -->
                    <h1>
                        <i class="fa fa-circle-o-notch fa-spin"></i>
                        
                            <a href="." >04 - All request</a>
                        
                    </h1>
                </div>

                <div class="body-inner"><div class="page-wrapper" tabindex="-1" role="main">
    

    <div class="page-inner">
        <div id="book-search-results">
            <div class="search-noresults">
                <section class="normal markdown-section">
                    
                        <h1 id="/implementation/04-all-request">04 - All request</h1>
                    

                    <blockquote>
  <p><strong><em>BRANCH:</em></strong>  You can start from the branch <code class="language-plaintext highlighter-rouge">timeout</code>.</p>

  <p><code class="language-plaintext highlighter-rouge">git checkout timeout</code></p>
</blockquote>

<p>We were able to trigger the first request and if it has not finished in the specified time, we will raise the
timeout error.</p>

<p>Now, we are going to implement the second and the third request. Those two requests should be triggered after 300ms from
the first one. In addition, they should be triggered at once, and we should return the first successful. If the first
request finishes after 300ms, but before the second and third, we will return it.</p>

<h2 id="implementing-the-second-and-third-request">Implementing the second and third request</h2>

<p>As you might guess, all our requests will be done asynchronously. We need to secure that the second and the third
request is triggered after 300ms after the first one.</p>

<p> 1. We are going to postpone the fetch by a specific time.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">async</span> <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="n">delay_seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Success</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay_seconds</span><span class="p">)</span>


<span class="p">...</span>
</code></pre></div></div>

<blockquote>
  <p><strong><em>QUESTION:</em></strong> Why we used <code class="language-plaintext highlighter-rouge">asyncio.sleep</code> and no classic one time.sleep?</p>
</blockquote>

<details><summary>Click on me for the answer!</summary>
<p>When time.sleep(x) is called, it will block the entire execution of the script, and it will be put on hold, just
frozen, doing nothing. But when you call await asyncio.sleep(x), it will ask the event loop to run something else
while your await statement finishes its execution.</p>
</details>

<p> 2. Create tasks.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"/api/smart"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">smart_api_requester</span><span class="p">():</span>
    <span class="n">timeout_seconds</span> <span class="o">=</span> <span class="n">get_and_validate_timeout</span><span class="p">()</span>
    <span class="n">unfinished_tasks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">fetch</span><span class="p">(</span><span class="n">delay_seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
        <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">fetch</span><span class="p">(</span><span class="n">delay_seconds</span><span class="o">=</span><span class="n">WAIT_BEFORE_NEXT_REQUEST_SECONDS</span><span class="p">)),</span>
        <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">fetch</span><span class="p">(</span><span class="n">delay_seconds</span><span class="o">=</span><span class="n">WAIT_BEFORE_NEXT_REQUEST_SECONDS</span><span class="p">)),</span>
    <span class="p">]</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>As we can see, we created 3 tasks. The first request won’t be delayed, the second and third one will be delayed for the
time specified in the assignment.</p>

<p> 3. Execute those task.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">out_of_time</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="bp">None</span> <span class="o">|</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span>


<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"/api/smart"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">smart_api_requester</span><span class="p">():</span>
    <span class="n">timeout_seconds</span> <span class="o">=</span> <span class="n">get_and_validate_timeout</span><span class="p">()</span>
    <span class="n">unfinished_tasks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">fetch</span><span class="p">(</span><span class="n">delay_seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
        <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">fetch</span><span class="p">(</span><span class="n">delay_seconds</span><span class="o">=</span><span class="n">WAIT_BEFORE_NEXT_REQUEST_SECONDS</span><span class="p">)),</span>
        <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">fetch</span><span class="p">(</span><span class="n">delay_seconds</span><span class="o">=</span><span class="n">WAIT_BEFORE_NEXT_REQUEST_SECONDS</span><span class="p">)),</span>
    <span class="p">]</span>
    <span class="n">timeout_remaining</span> <span class="o">=</span> <span class="n">timeout_seconds</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">out_of_time</span><span class="p">(</span><span class="n">timeout_remaining</span><span class="p">)</span> <span class="ow">and</span> <span class="n">unfinished_tasks</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="n">finished_tasks</span><span class="p">,</span> <span class="n">unfinished_tasks</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span>
            <span class="n">unfinished_tasks</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_remaining</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">finished_task</span> <span class="ow">in</span> <span class="n">finished_tasks</span><span class="p">:</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">finished_task</span><span class="p">.</span><span class="n">result</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="n">timeout_remaining</span> <span class="o">=</span> <span class="n">timeout_remaining</span> <span class="o">-</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="k">if</span> <span class="n">timeout_remaining</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">timeout_remaining</span>

    <span class="k">if</span> <span class="n">out_of_time</span><span class="p">(</span><span class="n">timeout_remaining</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">RequestTimeout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="p">{})</span>
</code></pre></div></div>

<p>We wait for the first task to finish. However, this task could finish with an error or with not successful response.
Therefor, we need to repeat our loop till we don’t receive the first successful response, or we are not out of time.</p>

<blockquote>
  <p><strong><em>QUESTION:</em></strong> There is still one problem in how we handle our tasks, can you spot the problem?</p>
</blockquote>

<details><summary>Click on me for the answer!</summary>
<p>If we got successful response, we will return it, but there might still be two tasks in the event loop.
As we don’t need the result from them, we can cancel them.</p>

<ul>
  <li>Cancel unfinished tasks
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="p">...</span>      
 <span class="k">for</span> <span class="n">unfinished_task</span> <span class="ow">in</span> <span class="n">unfinished_tasks</span><span class="p">:</span>
     <span class="n">unfinished_task</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
          
 <span class="k">if</span> <span class="n">out_of_time</span><span class="p">(</span><span class="n">timeout_remaining</span><span class="p">):</span>
     <span class="k">raise</span> <span class="n">RequestTimeout</span><span class="p">()</span>
 <span class="p">...</span>
</code></pre></div>    </div>
  </li>
</ul>

</details>

                </section>
            </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div></div>
    </div>
</div>

                        <a href="/pycon-2022/implementation/2022-09-09-03-timeout.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: 03 - Timeout">
                            <i class="fa fa-angle-left"></i>
                        </a>
                    

                    
                        <a href="/pycon-2022/implementation/2022-09-09-05-add-tests.html" class="navigation navigation-next navigation-unique" aria-label="Next page: 05 - Add tests">
                            <i class="fa fa-angle-right"></i>
                        </a>
                    
                </div>
            </div>

            <script>
            var gitbook = gitbook || [];
            gitbook.push(function() {
                gitbook.page.hasChanged({
    "page": {
        "title": "Introduction",
        "level": "1.1",
        "depth": 1,
        
        "next": {
            "title": "05 - Add tests",
            "level": "1.2",
            "depth": 1,
            "path": "_posts/2022-09-09-05-add-tests.md",
            "ref": "_posts/2022-09-09-05-add-tests.md",
            "articles": []
        },
        
        "dir": "ltr"
    },    "config": {
        "plugins": ["fontsettings", "highlight", "livereload", "lunr", "search", "sharing", "theme-default", "livereload"],
        "styles": {
            "ebook": "styles/ebook.css",
            "epub": "styles/epub.css",
            "mobi": "styles/mobi.css",
            "pdf": "styles/pdf.css",
            "print": "styles/print.css",
            "website": "styles/website.css"
        },
        "pluginsConfig": {
            "fontsettings": {
                "family": "sans",
                "size": 2,
                "theme": "white"
            },
            "highlight": {},
            "livereload": {},
            "lunr": {
                "ignoreSpecialCharacters": false,
                "maxIndexSize": 1000000
            },
            "search": {},            "sharing": {
                "all": ["facebook", "google", "twitter", "weibo", "instapaper", "github", "telegram"],
                "facebook": true,
                "google": false,
                "github": true,
                "github_link": "https://github.com",
                "telegram": false,
                "telegram_link": "https://t.me",
                "instapaper": false,
                "twitter": true,
                "vk": false,
                "weibo": false
            },
"theme-default": {
                "showLevel": false,
                "styles": {
                    "ebook": "styles/ebook.css",
                    "epub": "styles/epub.css",
                    "mobi": "styles/mobi.css",
                    "pdf": "styles/pdf.css",
                    "print": "styles/print.css",
                    "website": "styles/website.css"
                }
            }
        },
        "theme": "default",
        "author": "Tao He",
        "pdf": {
            "pageNumbers": true,
            "fontSize": 12,
            "fontFamily": "Arial",
            "paperSize": "a4",
            "chapterMark": "pagebreak",
            "pageBreaksBefore": "/",
            "margin": {
                "right": 62,
                "left": 62,
                "top": 56,
                "bottom": 56
            }
        },
        "structure": {
            "langs": "LANGS.md",
            "readme": "README.md",
        },
        "variables": {},
        "title": "Pycon Workshop Bloomreach",
        "language": "en",
        "gitbook": "*"
    },
    "file": {
        "path": "_posts/2022-09-09-04-all-request.md",
        "mtime": "2022-09-09 00:00:00 +0000",
        "type": "markdown"
    },
    "gitbook": {
        "version": "3.2.3",
        "time": "2022-09-11 08:12:09 +0000"
    },
    "basePath": "/pycon-2022",
    "book": {
        "language": ""
    }
});
            });
            </script>
        </div><script src="/pycon-2022/assets/gitbook/gitbook.js"></script>
<script src="/pycon-2022/assets/gitbook/theme.js"></script>

<script src="/pycon-2022/assets/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
<script src="/pycon-2022/assets/gitbook/gitbook-plugin-sharing/buttons.js"></script>

<!-- <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
<script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
<script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
<script src="../gitbook/gitbook-plugin-search/search.js"></script> -->

<script src="/pycon-2022/assets/gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
<script src="/pycon-2022/assets/gitbook/gitbook-plugin-search-pro/search.js"></script>
<script src="/pycon-2022/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>

<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

</body>
</html>