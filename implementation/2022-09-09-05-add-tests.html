<!DOCTYPE HTML>
<html lang="en" >
    <head><meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"><title>05 - Add tests · Pycon Workshop Bloomreach</title><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="description" content="On Pycon 2022 Bloomreach reveals their hiring assignment. On this pages are documents describing how to implement it,  and questions that will help you to understand better the assignment and things used in the implementation."><meta name="generator" content="Jekyll (using style of GitBook 3.2.3)"><meta name="author" content="Ondrej Unger"><link rel="stylesheet" href="/pycon-2022/assets/gitbook/style.css">
<link rel="stylesheet" href="/pycon-2022/assets/gitbook/gitbook-plugin-fontsettings/website.css">
<link rel="stylesheet" href="/pycon-2022/assets/gitbook/gitbook-plugin-search-pro/search.css">
<link rel="stylesheet" href="/pycon-2022/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.css">

<link rel="stylesheet" href="/pycon-2022/assets/gitbook/rouge/colorful.css">

<link rel="stylesheet" href="/pycon-2022/assets/gitbook/custom.css">

<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/pycon-2022/assets/gitbook/images/apple-touch-icon-precomposed-152.png">
<link rel="shortcut icon" href="/pycon-2022//assets/gitbook/images/favicon.png" type="image/x-icon">





<script>
    MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        svg: {
            fontCache: 'global'
        }
    };
</script>
            <link rel="prev" href="/pycon-2022/implementation/2022-09-09-04-all-request.html" />
        

        
    </head>
    <body>
        <div class="book"><div class="book-summary">
    <nav role="navigation">
        <div id="book-search-input" role="search">
            <input type="text" placeholder="Type to search" />
        </div>
        <div id="book-search-input-link" role="search">
            <a href="/pycon-2022/assets/search.html">Click to Search</a>
        </div>
        <ul class="summary">
            
            <li class="chapter" data-level="1.1" data-path="/pycon-2022">
            
                <a href="/pycon-2022/">
                    Pycon Workshop Bloomreach
                </a>
            </li>

            <li class="divider"></li>

            
                <!-- <p>pages</p> -->
                
                    

                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pycon-2022/pages/about/">
                        
                            <a href="/pycon-2022/pages/about/">
                                About
                            </a>
                            
                                
                            
                        </li>
                    

                    
                        <li class="divider"></li>
                    
                
            
                <!-- <p>posts</p> -->
                
                    

                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pycon-2022/assignment/2022-09-09-00-assigment.html">
                        
                            <a href="/pycon-2022/assignment/2022-09-09-00-assigment.html">
                                00 - Assignment
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pycon-2022/implementation/2022-09-09-01-start.html">
                        
                            <a href="/pycon-2022/implementation/2022-09-09-01-start.html">
                                01 - Start
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pycon-2022/implementation/2022-09-09-02-first-request.html">
                        
                            <a href="/pycon-2022/implementation/2022-09-09-02-first-request.html">
                                02 - First Request
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pycon-2022/implementation/2022-09-09-03-timeout.html">
                        
                            <a href="/pycon-2022/implementation/2022-09-09-03-timeout.html">
                                03 - Timeout
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/pycon-2022/implementation/2022-09-09-04-all-request.html">
                        
                            <a href="/pycon-2022/implementation/2022-09-09-04-all-request.html">
                                04 - All request
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter active" data-level="1.2" data-path="/pycon-2022/implementation/2022-09-09-05-add-tests.html">
                        
                            <a href="/pycon-2022/implementation/2022-09-09-05-add-tests.html">
                                05 - Add tests
                            </a>
                            
                                
                                    <ul><li><a href="#add-tests-for-fetch">Add tests for fetch</a></li></ul>

                                
                            
                        </li>
                    

                    
                        <li class="divider"></li>
                    
                
            

            <li>
                <a href="https://github.com/UOndro/pycon-2022/fork" target="blank" class="gitbook-link">
                    Fork it Now!
                </a>
            </li>
        </ul>
    </nav>
</div>
<div class="book-body">
                <div class="book-header" role="navigation">
                    <!-- Title -->
                    <h1>
                        <i class="fa fa-circle-o-notch fa-spin"></i>
                        
                            <a href="." >05 - Add tests</a>
                        
                    </h1>
                </div>

                <div class="body-inner"><div class="page-wrapper" tabindex="-1" role="main">
    

    <div class="page-inner">
        <div id="book-search-results">
            <div class="search-noresults">
                <section class="normal markdown-section">
                    
                        <h1 id="/implementation/05-add-tests">05 - Add tests</h1>
                    

                    <blockquote>
  <p><strong><em>BRANCH:</em></strong>  You can start from the branch <code class="language-plaintext highlighter-rouge">all-requests</code>.</p>

  <p><code class="language-plaintext highlighter-rouge">git checkout all-requests</code></p>
</blockquote>

<p>Finally, we are going to add some tests.</p>

<h2 id="add-tests-for-fetch">Add tests for fetch</h2>

<p>We are going to use very popular test framework <code class="language-plaintext highlighter-rouge">pytest</code>.</p>

<p> 1. Create a test directory and test file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir tests
touch __init__.py
touch test_fetch.py
</code></pre></div></div>

<p> 2. Install <code class="language-plaintext highlighter-rouge">pytest</code>, <code class="language-plaintext highlighter-rouge">pytest-asyncio</code> and <code class="language-plaintext highlighter-rouge">pytest-httpserver</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip install pytest pytest-httpserver
</code></pre></div></div>

<p> 3. <code class="language-plaintext highlighter-rouge">pytest-httpserver</code> allows us to create a local server, which we will use in tests. To be able to use it, we
need to
modify <code class="language-plaintext highlighter-rouge">fetch</code> function.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="n">delay_seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">BLOOMREACH_SERVER</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Success</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>We will pass the URL as parameter, so we can simply modify it.</p>

<blockquote>
  <p><strong><em>QUESTION:</em></strong> Do you know how this pattern is called?</p>
</blockquote>

<details><summary>Click on me for the answer!</summary>
<p>This pattern is called Dependency Injection, where an object or function receives other objects or functions that it
depends on.</p>

</details>

<p> 4. Create fetch tests.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">pytest_httpserver</span> <span class="kn">import</span> <span class="n">HTTPServer</span>
<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">Response</span>

<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">fetch</span><span class="p">,</span> <span class="n">get_first_successful_request</span>


<span class="k">def</span> <span class="nf">slow_response</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">time_to_wait_seconds</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">time_to_wait_seconds</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">({</span><span class="s">"time"</span><span class="p">:</span> <span class="n">time_to_wait_seconds</span><span class="p">}),</span> <span class="n">status</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s">"application/json"</span><span class="p">)</span>


<span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">mark</span><span class="p">.</span><span class="n">asyncio</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">test_successful_fetch</span><span class="p">(</span><span class="n">httpserver</span><span class="p">:</span> <span class="n">HTTPServer</span><span class="p">):</span>
    <span class="n">httpserver</span><span class="p">.</span><span class="n">expect_request</span><span class="p">(</span><span class="s">"/foobar"</span><span class="p">).</span><span class="n">respond_with_handler</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">slow_response</span><span class="p">,</span> <span class="n">time_to_wait_seconds</span><span class="o">=</span><span class="mf">0.2</span><span class="p">))</span>

    <span class="n">success</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">fetch</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">httpserver</span><span class="p">.</span><span class="n">url_for</span><span class="p">(</span><span class="s">"/foobar"</span><span class="p">))</span>

    <span class="k">assert</span> <span class="n">success</span>
    <span class="k">assert</span> <span class="p">{</span><span class="s">"time"</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">}</span> <span class="o">==</span> <span class="n">result</span>


<span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">mark</span><span class="p">.</span><span class="n">asyncio</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">test_unsuccessful_fetch</span><span class="p">(</span><span class="n">httpserver</span><span class="p">:</span> <span class="n">HTTPServer</span><span class="p">):</span>
    <span class="n">httpserver</span><span class="p">.</span><span class="n">expect_request</span><span class="p">(</span><span class="s">"/foobar"</span><span class="p">).</span><span class="n">respond_with_handler</span><span class="p">(</span>
        <span class="n">partial</span><span class="p">(</span><span class="n">slow_response</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">time_to_wait_seconds</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">success</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">fetch</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">httpserver</span><span class="p">.</span><span class="n">url_for</span><span class="p">(</span><span class="s">"/foobar"</span><span class="p">))</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">success</span>
</code></pre></div></div>

<p>We created a simple handler that returns similar responses to our Bloomreach testing server. In the first test, we
expect that server returns success and correct json. In the second one, we expect that success will be <code class="language-plaintext highlighter-rouge">false</code>.</p>

<p> 4. Let’s create now test for first successful response. First we need to do a small refactoring.</p>

<p>First move the code, which we would like to test, from app to a separate function.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="k">def</span> <span class="nf">get_first_successful_request</span><span class="p">(</span><span class="n">unfinished_tasks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">Task</span><span class="p">],</span> <span class="n">timeout</span><span class="p">:</span> <span class="bp">None</span> <span class="o">|</span> <span class="nb">float</span><span class="p">):</span>
    <span class="n">timeout_remaining</span> <span class="o">=</span> <span class="n">timeout</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">out_of_time</span><span class="p">(</span><span class="n">timeout_remaining</span><span class="p">)</span> <span class="ow">and</span> <span class="n">unfinished_tasks</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="n">finished_tasks</span><span class="p">,</span> <span class="n">unfinished_tasks</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span>
            <span class="n">unfinished_tasks</span><span class="p">,</span> <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="p">.</span><span class="n">FIRST_COMPLETED</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_remaining</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">finished_task</span> <span class="ow">in</span> <span class="n">finished_tasks</span><span class="p">:</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">finished_task</span><span class="p">.</span><span class="n">result</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">success</span><span class="p">,</span> <span class="n">result</span>

        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="n">timeout_remaining</span> <span class="o">=</span> <span class="n">timeout_remaining</span> <span class="o">-</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="k">if</span> <span class="n">timeout_remaining</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">timeout_remaining</span>

    <span class="k">for</span> <span class="n">unfinished_task</span> <span class="ow">in</span> <span class="n">unfinished_tasks</span><span class="p">:</span>
        <span class="n">unfinished_task</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">out_of_time</span><span class="p">(</span><span class="n">timeout_remaining</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">RequestTimeout</span><span class="p">()</span>

    <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="p">{}</span>
</code></pre></div></div>

<p>Then update the app function, so it uses our new function.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"/api/smart"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">smart_api_requester</span><span class="p">():</span>
    <span class="n">timeout_seconds</span> <span class="o">=</span> <span class="n">get_and_validate_timeout</span><span class="p">()</span>
    <span class="n">unfinished_tasks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">fetch</span><span class="p">(</span><span class="n">delay_seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
        <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">fetch</span><span class="p">(</span><span class="n">delay_seconds</span><span class="o">=</span><span class="n">WAIT_BEFORE_NEXT_REQUEST_SECONDS</span><span class="p">)),</span>
        <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">fetch</span><span class="p">(</span><span class="n">delay_seconds</span><span class="o">=</span><span class="n">WAIT_BEFORE_NEXT_REQUEST_SECONDS</span><span class="p">)),</span>
    <span class="p">]</span>

    <span class="n">success</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_first_successful_request</span><span class="p">(</span><span class="n">unfinished_tasks</span><span class="p">,</span> <span class="n">timeout_seconds</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></div>

<p> 5. We cannot use one server as we did with Bloomreach testing server. The reason is that <code class="language-plaintext highlighter-rouge">pytest-httpserver</code>
cannot process more than one server. So, we overcome this problem by creating multiple servers. Each running in
different thread.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">httpserver1</span><span class="p">(</span><span class="n">httpserver_ssl_context</span><span class="p">,</span> <span class="n">httpserver_listen_address</span><span class="p">):</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">HTTPServer</span><span class="p">.</span><span class="n">DEFAULT_LISTEN_HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">7001</span><span class="p">,</span> <span class="n">ssl_context</span><span class="o">=</span><span class="n">httpserver_ssl_context</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">server</span>
    <span class="n">server</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">server</span><span class="p">.</span><span class="n">is_running</span><span class="p">():</span>
        <span class="n">server</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>


<span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">httpserver2</span><span class="p">(</span><span class="n">httpserver_ssl_context</span><span class="p">,</span> <span class="n">httpserver_listen_address</span><span class="p">):</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">HTTPServer</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">HTTPServer</span><span class="p">.</span><span class="n">DEFAULT_LISTEN_HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">7002</span><span class="p">,</span> <span class="n">ssl_context</span><span class="o">=</span><span class="n">httpserver_ssl_context</span><span class="p">)</span>
    <span class="n">server</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">server</span>
    <span class="n">server</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">server</span><span class="p">.</span><span class="n">is_running</span><span class="p">():</span>
        <span class="n">server</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
</code></pre></div></div>

<p> 6. The last test that we will implement will be getting the first successful response.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">pytest</span><span class="p">.</span><span class="n">mark</span><span class="p">.</span><span class="n">asyncio</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">test_first_successful_requests</span><span class="p">(</span><span class="n">httpserver</span><span class="p">:</span> <span class="n">HTTPServer</span><span class="p">,</span> <span class="n">httpserver1</span><span class="p">,</span> <span class="n">httpserver2</span><span class="p">):</span>
    <span class="n">httpserver</span><span class="p">.</span><span class="n">expect_request</span><span class="p">(</span><span class="s">"/foo"</span><span class="p">).</span><span class="n">respond_with_handler</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">slow_response</span><span class="p">,</span> <span class="n">time_to_wait_seconds</span><span class="o">=</span><span class="mf">0.8</span><span class="p">))</span>
    <span class="n">httpserver1</span><span class="p">.</span><span class="n">expect_request</span><span class="p">(</span><span class="s">"/foo"</span><span class="p">).</span><span class="n">respond_with_handler</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">slow_response</span><span class="p">,</span> <span class="n">time_to_wait_seconds</span><span class="o">=</span><span class="mf">0.2</span><span class="p">))</span>
    <span class="n">httpserver2</span><span class="p">.</span><span class="n">expect_request</span><span class="p">(</span><span class="s">"/foo"</span><span class="p">).</span><span class="n">respond_with_handler</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">slow_response</span><span class="p">,</span> <span class="n">time_to_wait_seconds</span><span class="o">=</span><span class="mf">0.4</span><span class="p">))</span>

    <span class="n">unfinished_tasks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">fetch</span><span class="p">(</span><span class="n">delay_seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">httpserver</span><span class="p">.</span><span class="n">url_for</span><span class="p">(</span><span class="s">"/foo"</span><span class="p">))),</span>
        <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">fetch</span><span class="p">(</span><span class="n">delay_seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">httpserver1</span><span class="p">.</span><span class="n">url_for</span><span class="p">(</span><span class="s">"/foo"</span><span class="p">))),</span>
        <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">fetch</span><span class="p">(</span><span class="n">delay_seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">httpserver2</span><span class="p">.</span><span class="n">url_for</span><span class="p">(</span><span class="s">"/foo"</span><span class="p">))),</span>
    <span class="p">]</span>
    <span class="n">success</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_first_successful_request</span><span class="p">(</span><span class="n">unfinished_tasks</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">success</span>
    <span class="k">assert</span> <span class="p">{</span><span class="s">"time"</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">}</span> <span class="o">==</span> <span class="n">result</span>
</code></pre></div></div>

<p>Each http server has same route, but with different sleep time. This means that the server with the lowest sleep time
should answer first.</p>

<blockquote>
  <p><strong><em>QUESTION:</em></strong> Do you think we need more tests? If yes, what would they test?</p>
</blockquote>

<details><summary>Click on me for the answer!</summary>
<p>We definitely miss tests that would validate if <code class="language-plaintext highlighter-rouge">get_first_successful_request</code> ends always in specified timeout. We also
could add some tests that would validate what happens if the testing server reaches timeout or will respond with invalid
content.</p>

</details>

                </section>
            </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div></div>
    </div>
</div>

                        <a href="/pycon-2022/implementation/2022-09-09-04-all-request.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: 04 - All request">
                            <i class="fa fa-angle-left"></i>
                        </a>
                    

                    
                </div>
            </div>

            <script>
            var gitbook = gitbook || [];
            gitbook.push(function() {
                gitbook.page.hasChanged({
    "page": {
        "title": "Introduction",
        "level": "1.1",
        "depth": 1,
        
        "dir": "ltr"
    },    "config": {
        "plugins": ["fontsettings", "highlight", "livereload", "lunr", "search", "sharing", "theme-default", "livereload"],
        "styles": {
            "ebook": "styles/ebook.css",
            "epub": "styles/epub.css",
            "mobi": "styles/mobi.css",
            "pdf": "styles/pdf.css",
            "print": "styles/print.css",
            "website": "styles/website.css"
        },
        "pluginsConfig": {
            "fontsettings": {
                "family": "sans",
                "size": 2,
                "theme": "white"
            },
            "highlight": {},
            "livereload": {},
            "lunr": {
                "ignoreSpecialCharacters": false,
                "maxIndexSize": 1000000
            },
            "search": {},            "sharing": {
                "all": ["facebook", "google", "twitter", "weibo", "instapaper", "github", "telegram"],
                "facebook": true,
                "google": false,
                "github": true,
                "github_link": "https://github.com",
                "telegram": false,
                "telegram_link": "https://t.me",
                "instapaper": false,
                "twitter": true,
                "vk": false,
                "weibo": false
            },
"theme-default": {
                "showLevel": false,
                "styles": {
                    "ebook": "styles/ebook.css",
                    "epub": "styles/epub.css",
                    "mobi": "styles/mobi.css",
                    "pdf": "styles/pdf.css",
                    "print": "styles/print.css",
                    "website": "styles/website.css"
                }
            }
        },
        "theme": "default",
        "author": "Tao He",
        "pdf": {
            "pageNumbers": true,
            "fontSize": 12,
            "fontFamily": "Arial",
            "paperSize": "a4",
            "chapterMark": "pagebreak",
            "pageBreaksBefore": "/",
            "margin": {
                "right": 62,
                "left": 62,
                "top": 56,
                "bottom": 56
            }
        },
        "structure": {
            "langs": "LANGS.md",
            "readme": "README.md",
        },
        "variables": {},
        "title": "Pycon Workshop Bloomreach",
        "language": "en",
        "gitbook": "*"
    },
    "file": {
        "path": "_posts/2022-09-09-05-add-tests.md",
        "mtime": "2022-09-09 00:00:00 +0000",
        "type": "markdown"
    },
    "gitbook": {
        "version": "3.2.3",
        "time": "2022-09-11 08:12:09 +0000"
    },
    "basePath": "/pycon-2022",
    "book": {
        "language": ""
    }
});
            });
            </script>
        </div><script src="/pycon-2022/assets/gitbook/gitbook.js"></script>
<script src="/pycon-2022/assets/gitbook/theme.js"></script>

<script src="/pycon-2022/assets/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
<script src="/pycon-2022/assets/gitbook/gitbook-plugin-sharing/buttons.js"></script>

<!-- <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
<script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
<script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
<script src="../gitbook/gitbook-plugin-search/search.js"></script> -->

<script src="/pycon-2022/assets/gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
<script src="/pycon-2022/assets/gitbook/gitbook-plugin-search-pro/search.js"></script>
<script src="/pycon-2022/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>

<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

</body>
</html>